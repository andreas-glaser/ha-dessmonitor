FROM python:3.12-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    VIRTUAL_ENV=/opt/pytest-venv \
    PATH="/opt/pytest-venv/bin:$PATH" \
    PIP_EXTRA_INDEX_URL=https://wheels.home-assistant.io/mypy-dev/

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    build-essential \
    libffi-dev \
    libssl-dev \
    libjpeg-dev \
    zlib1g-dev \
    pkg-config \
    bluez \
    libbluetooth-dev \
    && rm -rf /var/lib/apt/lists/*

RUN python -m venv ${VIRTUAL_ENV}

COPY requirements_test.txt /tmp/requirements_test.txt

RUN . ${VIRTUAL_ENV}/bin/activate && \
    pip install --upgrade pip && \
    pip install -r /tmp/requirements_test.txt

WORKDIR /workspace

CMD ["pytest", "--maxfail=1", "--durations=10"]
